version: 0.2
env:
  variables:
    # Basic configuration
    BATCH_CPUS: "8"
    BATCH_MEMORY: "10240"
    BUILD_TARGET: "phylogenetic"
    CONFIG_FILES: "build-configs/nextstrain-automation/config.yaml build-configs/washington-state/config.yaml"
    # These must be set in CodeBuild environment variables
    # BATCH_QUEUE: (required)
    # BATCH_JOB_DEFINITION: (required)
    # S3_BUCKET: (required)
    # NEXTSTRAIN_USERNAME: (required - for nextstrain login)
    # NEXTSTRAIN_PASSWORD: (required - for nextstrain login, store as secret)
phases:
  build:
    commands:
      - echo "Starting West Nile Virus Nextstrain build..."
      - echo "Repository already cloned by CodeBuild. Current contents:"
      - pwd
      - ls -la

      - echo "Submitting WNV build to AWS Batch and watching progress..."
      - |
        # Capture the full output including Job ID while still displaying it
        nextstrain build --aws-batch --aws-batch-cpus ${BATCH_CPUS} --aws-batch-memory ${BATCH_MEMORY} --aws-batch-queue ${BATCH_QUEUE} --aws-batch-job ${BATCH_JOB_DEFINITION} --aws-batch-s3-bucket ${S3_BUCKET} ${BUILD_TARGET} --configfile ${CONFIG_FILES} 2>&1 | tee /tmp/nextstrain_output.log

        # Extract the Batch Job ID from the captured output
        BATCH_JOB_ID=$(grep -oP 'AWS Batch Job ID: \K[a-f0-9-]+' /tmp/nextstrain_output.log)

        if [ -z "$BATCH_JOB_ID" ]; then
          echo "ERROR: Failed to capture Batch Job ID"
          cat /tmp/nextstrain_output.log
          exit 1
        fi

        echo "Batch job completed with Job ID: ${BATCH_JOB_ID}"

      - echo "Downloading results from completed Batch job..."
      - nextstrain build --aws-batch --attach ${BATCH_JOB_ID} --download ${BUILD_TARGET}/auspice/*.json .

      - echo "Checking files"
      - ls

      - echo "Checking that auspice output was retrieved "
      - ls ${BUILD_TARGET}/auspice/

      - echo "Logging into Nextstrain..."
      - nextstrain login --no-prompt

      - echo "Uploading results to Nextstrain..."
      - nextstrain remote upload nextstrain.org/groups/wadoh-private ${BUILD_TARGET}/auspice/*.json

      - echo "Build and upload completed successfully!"
